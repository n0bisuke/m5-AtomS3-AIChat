# AtomS3 + EchoBase で音が鳴るまでの検証メモ

AtomS3 に EchoBase を繋いでスピーカーが鳴らない問題を切り分けた記録です。  
最終的に「ES8311 の初期化が抜けていた」ことが原因でした。

## 目的

- EchoBase のスピーカーがちゃんと鳴るか確認したい
- マイク/スピーカーどちらが原因かを切り分けたい

## 最初の状態

- I2S でスピーカーを鳴らすテストコードを用意
- 画面ボタンを押している間だけ 1kHz トーンを鳴らす
- 結果: **音が鳴らない**

## 切り分けの方針

1. スピーカー単体テストにする（マイクを切り離す）
2. I2C デバイスが見えているか確認する
3. EchoBase のオーディオコーデック（ES8311）を初期化する

## 実際にやったこと

### 1. スピーカー単体テスト

- マイク処理を外して `M5.Speaker.tone(1000, 200)` だけ鳴らす
- 結果: **音が鳴らない**

### 2. I2C スキャンで状況把握

- 起動時に I2C スキャンを実行して、見えるアドレスを表示
- 表示結果: **0x18 / 0x43**

I2C は生きているので、配線や電源が完全に死んでいるわけではないと判断。

### 3. EchoBase のコーデック初期化を追加

EchoBase は ES8311 というコーデックを使っていて、  
これを初期化しないとスピーカーは鳴らない。

- `M5Atomic-EchoBase` ライブラリを GitHub から追加
- `echobase.init(...)` で ES8311 を初期化
- スピーカー音量を設定

この時点で **音が鳴るようになった**

## 変更点（抜粋）

### platformio.ini

```ini
lib_deps =
  m5stack/M5Unified @ ^0.2.0
  https://github.com/m5stack/M5Atomic-EchoBase.git
```

### src/main.cpp（重要部分）

```cpp
#include <M5EchoBase.h>
M5EchoBase echobase(I2S_NUM_0);

Wire.begin(38, 39);
echobase.init(16000, 38, 39, 7, 6, 5, 8, Wire);
echobase.setSpeakerVolume(70);
```

## まとめ

- I2C でデバイスが見えていても、**ES8311 を初期化しないとスピーカーは鳴らない**
- I2C スキャンは「配線/電源が生きているか」を確認するのに有効
- 音が鳴らない時は、まず **スピーカー単体テスト → I2C スキャン → コーデック初期化** が早い

## 次の課題

- マイク単体テスト（入力レベル表示）
- 元の「押している間だけ中継」に戻して動作確認
